name: CI - Development   # This workflow runs our CI pipeline on every push to master

on:
  push:
    branches:
      - master           # We only trigger this workflow when we push to the master branch

jobs:
  test-and-build:
    runs-on: ubuntu-latest   # We run our pipeline on the latest Ubuntu GitHub-hosted runner

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # We fetch our repository code into the CI runner,
        # so all subsequent steps can access the Laravel project files.

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, bcmath, intl
        # We install PHP 8.4 and the required extensions
        # to match the runtime environment of our Laravel application.

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-interaction
        # We install all PHP dependencies, including dev dependencies,
        # so that our testing tools (like PHPUnit) are available in CI.

      - name: Install NPM dependencies
        run: npm ci
        # We install frontend dependencies using a clean, reproducible install
        # based on package-lock.json, to keep builds deterministic.

      - name: Build assets
        run: npm run build
        # We compile our frontend assets (CSS/JS) for production
        # using the existing Vite/Mix build configuration.

      - name: Prepare Laravel environment
        run: |
          cp .env.example .env
          php artisan key:generate
        # We create a fresh .env file inside the CI runner by copying .env.example.
        # Then we generate a new APP_KEY so that encryption, sessions,
        # and other framework features depending on the key work correctly during tests.
        # In .env.example, we configure the database to use SQLite,
        # which is suitable for an isolated testing environment in CI.

      - name: Run tests
        run: php artisan test || echo "Some tests failed, but continuing pipeline"
        # We execute the full Laravel test suite using `php artisan test`.
        # If some tests fail, the command would normally return a non-zero exit code.
        # By adding `|| echo "Some tests failed, but continuing pipeline"`,
        # we tell CI to print a message and continue the pipeline instead of stopping the job.
        # This allows us to still see the test results in the logs,
        # without blocking the build and deployment steps.

      - name: Create ZIP artifact
        run: |
          zip -r deploy-dev.zip . -x "vendor/*" "node_modules/*" ".git/*" "tests/*"
        # We package the Laravel application into a ZIP file for deployment,
        # excluding heavy and non-essential directories such as vendor, node_modules,
        # Git metadata, and test files.

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-dev-zip
          path: deploy-dev.zip
        # We upload the deployment ZIP as a CI artifact,
        # so it can be reused later by a separate CD (deployment) workflow or downloaded manually.